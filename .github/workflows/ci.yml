name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  CARGO_TERM_COLOR: always
  SOLANA_CLI_VERSION: v3.1.7

jobs:
  run_cargo_checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: Swatinem/rust-cache@v2
      - name: Rust install nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: clippy, rustfmt
      - name: Run Cargo fmt
        run: cargo +nightly fmt --all -- --check
      - name: Run Cargo clippy
        run: cargo clippy --all-targets --all-features

  run_benchmarks:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            benches/program-bench/ -> target
      - name: Rust install
        uses: dtolnay/rust-toolchain@stable
      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.anza.xyz/${SOLANA_CLI_VERSION}/install)"
          echo "/home/runner/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
      - name: Run benchmarks
        run: |
          chmod +x scripts/run-benchmarks.sh
          ./scripts/run-benchmarks.sh
      - name: Verify benchmark results are in sync
        run: |
          if git diff --quiet benches/BENCHMARK.md; then
            echo "Benchmark results are in sync"
          else
            echo "Benchmark results are out of sync. Run benchmarks and commit updated benches/BENCHMARK.md."
            git diff -- benches/BENCHMARK.md
            exit 1
          fi

  run_examples_tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        example:
          [
            "anchor-cpi",
            "counter",
            "cpi",
            "escrow",
            "hello-world",
            "instruction-data",
            "misc",
            "seeded",
            "seeds",
            "transfer-sol",
            "transfer-token",
          ]
    steps:
      - uses: actions/checkout@v5
      - name: Rust install
        uses: dtolnay/rust-toolchain@stable
      - name: Setup cache
        uses: Swatinem/rust-cache@v2
      - uses: taiki-e/install-action@just
      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.anza.xyz/${SOLANA_CLI_VERSION}/install)"
          echo "/home/runner/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
      - name: Build program
        run: just build ${{ matrix.example }}
      - name: Test program
        run: just test ${{ matrix.example }}

  run_basic_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: Swatinem/rust-cache@v2
      - name: Rust install
        uses: dtolnay/rust-toolchain@stable
      - name: Run tests
        run: cargo test --workspace --exclude typhoon-cli

  run_cli_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Reset Solana toolchain directories
        run: |
          rm -rf "$HOME/.cache/solana"
          rm -rf "$HOME/.local/share/solana"
      - name: Rust install
        uses: dtolnay/rust-toolchain@stable
      - name: Setup cache
        uses: Swatinem/rust-cache@v2
      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.anza.xyz/${SOLANA_CLI_VERSION}/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> "$GITHUB_PATH"
      - name: Warm up SBF tools
        run: |
          cargo build-sbf --force-tools-install || true
      - name: Test CLI
        run: cargo test -p typhoon-cli
